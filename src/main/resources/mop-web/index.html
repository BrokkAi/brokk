<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Brokk MOP</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; background-color: #fff; color: #111; margin: 1em; }
    body.theme-dark { background-color: #2b2b2b; color: #bbb; }
    pre { white-space: pre-wrap; word-break: break-all; }
    #spinner { padding: 0.5em; color: #888; }
    body.theme-dark #spinner { color: #888; }
  </style>
</head>
<body>
  <h1>MOP WebView Skeleton</h1>
  <p>Events from Java will be logged to the console and displayed raw below.</p>
  <pre id="log"></pre>
  <div id="spinner" style="display: none;"></div>
  <script>
    const log = document.getElementById('log');
    const spinner = document.getElementById('spinner');

    window.brokk = {
      onEvent: (payload) => {
        console.log('Received event from Java:', payload);

        switch (payload.type) {
          case 'chunk':
            log.textContent += JSON.stringify(payload, null, 2) + '\n';
            break;
          case 'theme':
            document.body.classList.toggle('theme-dark', payload.dark);
            break;
          case 'clear':
            log.textContent = '';
            break;
          case 'spinner':
            spinner.textContent = payload.message;
            spinner.style.display = payload.message ? 'block' : 'none';
            break;
        }

        // ACK after a frame render to ensure UI has updated
        if (payload.epoch) {
            requestAnimationFrame(() => {
                if (window.javaBridge) {
                    window.javaBridge.onAck(payload.epoch);
                } else {
                    console.error('javaBridge not available to ACK epoch ' + payload.epoch);
                }
            });
        }
      }
    };
    console.log('brokk event handler registered.');
  </script>
</body>
</html>
