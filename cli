package ai.brokk.ctl.cli;

import ai.brokk.ctl.CtlConfigPaths;
import ai.brokk.ctl.InstanceRecord;
import ai.brokk.util.Json;
import com.fasterxml.jackson.core.type.TypeReference;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.nio.file.Path;
import java.util.*;

/**
 * Tests for exec start CLI behavior (Phase 1).
 */
public class ExecStartTest {
    @TempDir
    Path tempDir;

    @Test
    public void planStartReturnsJobIdAndCursor() throws Exception {
        CtlConfigPaths cfg = CtlConfigPaths.forBaseConfigDir(tempDir);
        Path instancesDir = cfg.ensureInstancesDirExists();

        long now = System.currentTimeMillis();
        // Instance with the target project but no running executions
        InstanceRecord a = new InstanceRecord("id-a", 10, "addr-a", List.of("/proj/a"), "0.1.0", now - 500L, now - 200L);
        java.nio.file.Files.writeString(instancesDir.resolve("id-a.json"), a.toJson());

        ByteArrayOutputStream bout = new ByteArrayOutputStream();
        int rc = BrokkCtlMain.run(new String[] {
                "exec", "start",
                "--mode", "plan",
                "--instance", "id-a",
                "--path", "/proj/a",
                "--config-dir", tempDir.toString()
        }, new PrintStream(bout), System.err);

        assertEquals(0, rc);
        String out = bout.toString().trim();
        Map<String, Object> env = Json.fromJson(out, new TypeReference<Map<String, Object>>() {});
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> results = (List<Map<String, Object>>) env.get("results");
        assertNotNull(results);
        assertEquals(1, results.size());
        Map<String, Object> r = results.get(0);
        assertEquals("started", r.get("status"));
        assertNotNull(r.get("jobId"));
        assertNotNull(r.get("cursor"));
        assertEquals("/proj/a", r.get("project"));
        assertEquals("plan", r.get("mode"));
    }

    @Test
    public void startReturnsBusyWhenExecutionExistsForProject() throws Exception {
        CtlConfigPaths cfg = CtlConfigPaths.forBaseConfigDir(tempDir);
        Path instancesDir = cfg.ensureInstancesDirExists();

        long now = System.currentTimeMillis();
        // Base instance
        InstanceRecord a = new InstanceRecord("id-a", 10, "addr-a", List.of("/proj/a"), "0.1.0", now - 500L, now - 200L);

        // Build JSON map from instance and inject a running execution for the same project
        Map<String, Object> base = Json.fromJson(a.toJson(), new TypeReference<Map<String, Object>>() {});
        Map<String, Object> running = new LinkedHashMap<>();
        running.put("project", "/proj/a");
        running.put("state", "running");
        running.put("jobId", "job-1");
        base.put("executions", List.of(running));

        java.nio.file.Files.writeString(instancesDir.resolve("id-a.json"), Json.toJson(base));

        ByteArrayOutputStream bout = new ByteArrayOutputStream();
        int rc = BrokkCtlMain.run(new String[] {
                "exec", "start",
                "--mode", "plan",
                "--instance", "id-a",
                "--path", "/proj/a",
                "--config-dir", tempDir.toString()
        }, new PrintStream(bout), System.err);

        assertEquals(0, rc);
        String out = bout.toString().trim();
        Map<String, Object> env = Json.fromJson(out, new TypeReference<Map<String, Object>>() {});
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> results = (List<Map<String, Object>>) env.get("results");
        assertNotNull(results);
        assertEquals(1, results.size());
        Map<String, Object> r = results.get(0);
        assertEquals("busy", r.get("status"));
        @SuppressWarnings("unchecked")
        Map<String, Object> errObj = (Map<String, Object>) r.get("error");
        assertNotNull(errObj);
        assertEquals("BUSY", errObj.get("code"));
        assertTrue(errObj.get("message").toString().contains("/proj/a"));
    }
}
