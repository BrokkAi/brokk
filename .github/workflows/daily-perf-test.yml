name: Daily Performance Test

on:
  pull_request:
    branches: [ 'master' ] # todo: To be removed
  schedule:
    - cron: '0 3 * * *' # Run daily at 3 AM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  performance-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Fetch remote branches
        run: |
          git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/*

      - name: Prepare CI tools (scripts)
        run: |
          mkdir -p .ci-tools
          cp -v ./scripts/run-treesitter-repos.sh ./.ci-tools/run-treesitter-repos.sh
          cp -v ./scripts/compare-perf-results.js ./.ci-tools/compare-perf-results.js
          chmod +x ./.ci-tools/run-treesitter-repos.sh

      - name: Get commit hashes
        id: get_commits
        run: |
          # HEAD (current checkout)
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

          # Determine baseline branch:
          # - For PRs: use the PR base branch (e.g., master)
          # - For scheduled/manual runs: default to master
          BRANCH="${{ github.base_ref }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="master"
          fi
          echo "Using baseline branch: $BRANCH"

          # Ensure remote branches are present (in case checkout was shallow or remote refs missing)
          git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/*

          # Find the most recent commit on the baseline branch that is older than 24 hours
          BASE_SHA=$(git rev-list -n 1 --before="24 hours ago" "origin/$BRANCH" || true)
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          if [ -n "$BASE_SHA" ]; then
            echo "BASE_SHA_SHORT=$(git rev-parse --short $BASE_SHA)" >> $GITHUB_ENV
          else
            echo "BASE_SHA_SHORT=none" >> $GITHUB_ENV
          fi

      - name: Check for new commits
        id: check_commits
        run: |
          if [ "${{ env.HEAD_SHA }}" == "${{ env.BASE_SHA }}" ] || [ -z "${{ env.BASE_SHA }}" ]; then
            echo "No new commits in the last 24 hours or no prior commit found. Skipping performance test."
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "New commits found. Running performance test."
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java 21
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Node.js
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Gradle
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: gradle/actions/setup-gradle@v4

      - name: Setup test projects
        if: steps.check_commits.outputs.should_skip == 'false'
        run: ./.ci-tools/run-treesitter-repos.sh setup

      - name: Run benchmark on HEAD
        if: steps.check_commits.outputs.should_skip == 'false'
        run: |
          for i in {1..3}; do
            ./.ci-tools/run-treesitter-repos.sh multi-lang --output $(pwd)/report-head-$i --max-files 100
          done

      - name: Clean build artifacts
        if: steps.check_commits.outputs.should_skip == 'false'
        run: ./gradlew clean

      - name: Checkout BASE
        if: steps.check_commits.outputs.should_skip == 'false'
        run: git checkout ${{ env.BASE_SHA }}

      - name: Run benchmark on BASE
        if: steps.check_commits.outputs.should_skip == 'false'
        run: |
          for i in {1..3}; do
            ./.ci-tools/run-treesitter-repos.sh multi-lang --output $(pwd)/report-base-$i --max-files 100
          done

      - name: Compare results
        if: steps.check_commits.outputs.should_skip == 'false'
        id: compare
        run: |
          report=$(node ./.ci-tools/compare-perf-results.js report-base-* report-head-*)
          echo "markdown_report<<EOF" >> $GITHUB_OUTPUT
          echo "$report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send performance data to Slack Workflow
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_DAILY_PERF_WEBHOOK_URL }}
          webhook-type: webhook-trigger
          payload: |
            {
              "report_markdown": "${{ steps.compare.outputs.markdown_report }}",
              "head_sha_short": "${{ env.HEAD_SHA_SHORT }}",
              "base_sha_short": "${{ env.BASE_SHA_SHORT }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
