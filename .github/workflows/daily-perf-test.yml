name: Daily Performance Test

on:
  schedule:
    - cron: '0 3 * * *' # Run daily at 3 AM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  performance-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HEAD
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to get history for BASE_SHA

      - name: Get commit hashes
        id: get_commits
        run: |
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

          BASE_SHA=$(git rev-list -n 1 --before="24 hours ago" ${{ github.ref_name }})
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          if [ -n "$BASE_SHA" ]; then
            echo "BASE_SHA_SHORT=$(git rev-parse --short $BASE_SHA)" >> $GITHUB_ENV
          else
            echo "BASE_SHA_SHORT=none" >> $GITHUB_ENV
          fi

      - name: Check for new commits
        id: check_commits
        run: |
          if [ "${{ env.HEAD_SHA }}" == "${{ env.BASE_SHA }}" ] || [ -z "${{ env.BASE_SHA }}" ]; then
            echo "No new commits in the last 24 hours or no prior commit found. Skipping performance test."
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "New commits found. Running performance test."
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java 21
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Node.js
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Gradle
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: gradle/actions/setup-gradle@v4

      - name: Setup test projects
        if: steps.check_commits.outputs.should_skip == 'false'
        run: ./scripts/run-treesitter-repos.sh setup

      - name: Run benchmark on HEAD (${{ env.HEAD_SHA_SHORT }})
        if: steps.check_commits.outputs.should_skip == 'false'
        run: |
          for i in {1..3}; do
            ./scripts/run-treesitter-repos.sh multi-lang --output ./report-head-$i --max-files 8000
          done

      - name: Clean build artifacts
        if: steps.check_commits.outputs.should_skip == 'false'
        run: ./gradlew clean

      - name: Checkout BASE (${{ env.BASE_SHA_SHORT }})
        if: steps.check_commits.outputs.should_skip == 'false'
        run: git checkout ${{ env.BASE_SHA }}

      - name: Run benchmark on BASE
        if: steps.check_commits.outputs.should_skip == 'false'
        run: |
          for i in {1..3}; do
            ./scripts/run-treesitter-repos.sh multi-lang --output ./report-base-$i --max-files 8000
          done

      - name: Compare results
        if: steps.check_commits.outputs.should_skip == 'false'
        id: compare
        run: |
          report=$(node ./scripts/compare-perf-results.js report-base-* report-head-*)
          echo "markdown_report<<EOF" >> $GITHUB_OUTPUT
          echo "$report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Slack
        if: steps.check_commits.outputs.should_skip == 'false'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Daily Performance Report: ${{ env.HEAD_SHA_SHORT }} vs ${{ env.BASE_SHA_SHORT }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.compare.outputs.markdown_report }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Comparing `master@${{ env.HEAD_SHA_SHORT }}` with `master@${{ env.BASE_SHA_SHORT }}`. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
